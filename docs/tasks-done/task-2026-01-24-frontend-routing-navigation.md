# Task: Implement Basic Routing and Navigation

## Summary

Add client-side routing to the frontend to support navigation between main views (All Items, Conversations) and proper URL-based state.

## Acceptance Criteria

- [ ] Router setup using `@tanstack/react-router` with hash-based routing
- [ ] Routes defined:
  - `/` - Redirect to `/items`
  - `/items` - All items list view
  - `/items/:id` - Single item detail view
  - `/conversations` - Conversations list
  - `/conversations/:id` - Single conversation
  - `/settings` - Settings page (or use existing dialog)
  - `*` - 404/not-found route with redirect or error message
- [ ] Left sidebar shows navigation links with RTL-compatible styling
- [ ] Active route highlighted in sidebar
- [ ] Browser back/forward navigation works
- [ ] Deep linking works (paste URL, get correct view)
- [ ] Navigation commands registered in command system
- [ ] Tests for router configuration and navigation components

## Dependencies

- None (frontend shell already exists)
- **Note:** Translation keys (`nav.allItems`, `nav.conversations`, `nav.settings`) are handled by Task 10 (i18n Phase 1)

## Installation

```bash
bun add @tanstack/react-router @tanstack/router-plugin
```

## Technical Notes

### Router Setup Approach

Use **file-based routing** with the Vite plugin for automatic route generation:

```typescript
// vite.config.ts
import { TanStackRouterVite } from '@tanstack/router-plugin/vite'

export default defineConfig({
  plugins: [
    TanStackRouterVite({
      routesDirectory: './src/routes',
      generatedRouteTree: './src/routeTree.gen.ts',
    }),
    // ... other plugins
  ],
})
```

```typescript
// src/lib/router.ts
import { createRouter, createHashHistory } from '@tanstack/react-router'
import { routeTree } from '@/routeTree.gen'

// Hash history required for Tauri file:// protocol
const hashHistory = createHashHistory()

export const router = createRouter({
  routeTree,
  history: hashHistory,
})

declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router
  }
}
```

### File-Based Route Naming Convention

```
src/routes/
├── __root.tsx          # Root layout (wraps all routes)
├── index.tsx           # / → redirects to /items
├── items.tsx           # /items (layout for items routes)
├── items.index.tsx     # /items (list view)
├── items.$id.tsx       # /items/:id (detail view)
├── conversations.tsx   # /conversations (layout)
├── conversations.index.tsx  # /conversations (list view)
├── conversations.$id.tsx    # /conversations/:id (detail view)
├── settings.tsx        # /settings
└── $.tsx               # Catch-all 404 route
```

### RouterProvider Placement

```tsx
// main.tsx - Router wraps App, inside QueryClientProvider
<QueryClientProvider client={queryClient}>
  <RouterProvider router={router}>
    <App />
  </RouterProvider>
</QueryClientProvider>
```

### State Ownership Boundaries

| State Type       | Owner           | Example                      |
| ---------------- | --------------- | ---------------------------- |
| URL/route params | TanStack Router | Current route, item ID       |
| UI visibility    | Zustand         | Sidebar expanded, modal open |
| Server data      | TanStack Query  | Items list, conversations    |

### Anti-Pattern Warnings

```typescript
// ✅ GOOD: Selector syntax in route components
const leftSidebarVisible = useUIStore(state => state.leftSidebarVisible)

// ❌ BAD: Destructuring causes render cascades
const { leftSidebarVisible } = useUIStore()

// ✅ GOOD: Direct router.navigate() in command execute functions
execute: () => router.navigate({ to: '/items' })

// ❌ BAD: Using hooks in execute functions
execute: () => useNavigate()('/items')
```

## Left Sidebar Navigation

```tsx
// Navigation items for sidebar
const navItems = [
  { path: '/items', labelKey: 'nav.allItems', icon: FileTextIcon },
  {
    path: '/conversations',
    labelKey: 'nav.conversations',
    icon: MessageSquareIcon,
  },
]

// Use RTL-compatible CSS logical properties
// ✅ border-e-2 (not border-r-2) for active indicator
// ✅ ps-4 (not pl-4) for start padding
// ✅ pe-4 (not pr-4) for end padding
```

## Command System Integration

```typescript
// src/lib/commands/route-commands.ts
import { router } from '@/lib/router'
import type { Command } from '@/lib/commands/types'

export const routeCommands: Command[] = [
  {
    id: 'go-to-items',
    labelKey: 'commands.goToItems.label',
    group: 'navigation',
    execute: () => router.navigate({ to: '/items' }),
  },
  {
    id: 'go-to-conversations',
    labelKey: 'commands.goToConversations.label',
    group: 'navigation',
    execute: () => router.navigate({ to: '/conversations' }),
  },
]
```

## Files to Create/Modify

- `vite.config.ts` - Add TanStackRouterVite plugin
- `src/lib/router.ts` - Router configuration with hash history
- `src/routeTree.gen.ts` - Auto-generated by plugin (add to .gitignore)
- `src/routes/` - Route components (file-based routing)
  - `src/routes/__root.tsx` - Root layout wrapping all routes
  - `src/routes/index.tsx` - `/` redirect to /items
  - `src/routes/items.tsx` - `/items` layout
  - `src/routes/items.index.tsx` - `/items` list view
  - `src/routes/items.$id.tsx` - `/items/:id` detail view
  - `src/routes/conversations.tsx` - `/conversations` layout
  - `src/routes/conversations.index.tsx` - `/conversations` list view
  - `src/routes/conversations.$id.tsx` - `/conversations/:id` detail view
  - `src/routes/settings.tsx` - `/settings` page
  - `src/routes/$.tsx` - Catch-all 404 handler
- `src/lib/commands/route-commands.ts` - Navigation commands
- `src/components/layout/LeftSideBar.tsx` - Add navigation (preserve existing `className` prop and `cn()` pattern)
- `src/main.tsx` - Add RouterProvider
- `.gitignore` - Add `src/routeTree.gen.ts`
- `src/test/router.test.ts` - Router configuration tests
- `src/test/navigation.test.tsx` - Navigation component tests

## Verification

1. Navigate between routes using sidebar
2. Click back button returns to previous route
3. Refresh page maintains current route
4. Command palette still works from any route
5. Preferences dialog still works from any route
6. Invalid URLs show 404 page or redirect to /items
7. Navigation commands appear in command palette
8. `bun run check:all` passes (no Zustand destructuring in new components)

---

## Implementation Details

_Tracked: 2026-01-23_

### Files Changed

| File                                          | Change   | Description                                                           |
| --------------------------------------------- | -------- | --------------------------------------------------------------------- |
| `vite.config.ts`                              | Modified | Added TanStackRouterVite plugin with file-based routing configuration |
| `src/lib/router.ts`                           | Created  | Router configuration with hash history for Tauri compatibility        |
| `src/routes/__root.tsx`                       | Created  | Root layout wrapping MainWindowShell and router devtools              |
| `src/routes/index.tsx`                        | Created  | `/` route with redirect to `/items`                                   |
| `src/routes/$.tsx`                            | Created  | Catch-all 404 route with user-friendly not found page                 |
| `src/routes/items/route.tsx`                  | Created  | `/items` layout with Outlet                                           |
| `src/routes/items/index.tsx`                  | Created  | `/items` list view (placeholder)                                      |
| `src/routes/items/$id.tsx`                    | Created  | `/items/:id` detail view with param extraction                        |
| `src/routes/conversations/route.tsx`          | Created  | `/conversations` layout with Outlet                                   |
| `src/routes/conversations/index.tsx`          | Created  | `/conversations` list view (placeholder)                              |
| `src/routes/conversations/$id.tsx`            | Created  | `/conversations/:id` detail view with param extraction                |
| `src/routes/settings/route.tsx`               | Created  | `/settings` route opens preferences dialog, redirects to `/items`     |
| `src/lib/commands/route-commands.ts`          | Created  | Navigation commands for command palette                               |
| `src/lib/commands/index.ts`                   | Modified | Registered routeCommands in command system                            |
| `src/components/layout/LeftSideBar.tsx`       | Modified | Added navigation links with active state highlighting                 |
| `src/components/layout/MainWindowShell.tsx`   | Created  | Refactored main layout to accept children (route content)             |
| `src/components/layout/MainWindow.tsx`        | Deleted  | Replaced by MainWindowShell                                           |
| `src/components/layout/MainWindowContent.tsx` | Deleted  | No longer needed with routing                                         |
| `src/components/layout/index.ts`              | Modified | Updated exports for MainWindowShell                                   |
| `src/main.tsx`                                | Modified | Added RouterProvider wrapping App                                     |
| `src/App.tsx`                                 | Modified | Changed to accept children prop for route content                     |
| `src/App.test.tsx`                            | Modified | Updated tests for new App structure with children                     |
| `src/test/test-utils.tsx`                     | Modified | Added router setup with memory history for testing                    |
| `src/test/router.test.ts`                     | Created  | Router configuration tests                                            |
| `src/test/navigation.test.tsx`                | Created  | Navigation component tests                                            |
| `.gitignore`                                  | Modified | Added `src/routeTree.gen.ts` to ignore                                |
| `locales/en.json`                             | Modified | Added navigation, items, conversations, and notFound translation keys |
| `package.json`                                | Modified | Added @tanstack/react-router, @tanstack/router-plugin dependencies    |

### Dependencies Added

- `@tanstack/react-router@^1.154.12` - File-based routing for React
- `@tanstack/router-plugin@^1.154.12` - Vite plugin for auto-generating route tree
- `@tanstack/react-router-devtools@^1.154.12` (dev) - Router debugging tools
- `@tauri-apps/plugin-dialog@^2.6.0` - Upgraded existing dependency

### Acceptance Criteria Status

- [x] Router setup using `@tanstack/react-router` with hash-based routing - `src/lib/router.ts:5-9`
- [x] Routes defined:
  - [x] `/` - Redirect to `/items` - `src/routes/index.tsx:4-6`
  - [x] `/items` - All items list view - `src/routes/items/index.tsx`
  - [x] `/items/:id` - Single item detail view - `src/routes/items/$id.tsx`
  - [x] `/conversations` - Conversations list - `src/routes/conversations/index.tsx`
  - [x] `/conversations/:id` - Single conversation - `src/routes/conversations/$id.tsx`
  - [x] `/settings` - Opens preferences dialog and redirects - `src/routes/settings/route.tsx`
  - [x] `*` - 404/not-found route - `src/routes/$.tsx`
- [x] Left sidebar shows navigation links with RTL-compatible styling - `src/components/layout/LeftSideBar.tsx:33` uses `border-e`
- [x] Active route highlighted in sidebar - `src/components/layout/LeftSideBar.tsx:38-49`
- [x] Browser back/forward navigation works - Hash history handles this automatically
- [x] Deep linking works - Hash-based URLs persist on refresh
- [x] Navigation commands registered in command system - `src/lib/commands/route-commands.ts`, `src/lib/commands/index.ts:18`
- [x] Tests for router configuration and navigation components - `src/test/router.test.ts`, `src/test/navigation.test.tsx`

---

## Learning Report

_Generated: 2026-01-23_

### Summary

Implemented client-side routing for Cortex using TanStack Router with file-based routing and hash history. The implementation adds 10 route files, navigation commands, sidebar navigation links, and comprehensive test coverage. Key architectural decision was to use hash history for Tauri's `file://` protocol compatibility and file-based routing for type-safe, auto-generated route trees.

**Key Metrics:**

- 12 files created, 12 files modified, 2 files deleted
- 10 route components implemented
- 3 navigation commands added to command palette
- 4 test suites with router configuration and navigation tests

### Patterns & Decisions

1. **File-Based Routing Structure**: Used TanStack Router's file-based routing convention (`route.tsx` for layouts, `index.tsx` for index routes, `$param.tsx` for dynamic segments) rather than code-based route definitions. This provides automatic TypeScript type generation and clear file organization.

2. **Hash History for Tauri**: Chose `createHashHistory()` because Tauri uses `file://` protocol where traditional browser history API doesn't work. Hash-based URLs (`/#/items`) work correctly with local file protocols.

3. **Settings Route as Dialog Trigger**: Instead of a dedicated settings page, the `/settings` route opens the existing preferences dialog and redirects to `/items`. This maintains the existing modal-based settings UI while supporting direct URL access.

4. **MainWindowShell Refactor**: Extracted layout from the old `MainWindow` component into a new `MainWindowShell` that accepts `children` for route content. This follows the pattern of separating layout shell from content.

5. **Router in main.tsx, App for Initialization**: Kept `RouterProvider` in `main.tsx` while `App` remains the initialization component (command system, menu, etc.). App now accepts `children` to render route content.

6. **Selector Pattern Maintained**: All new components follow the Zustand selector pattern (`useUIStore(state => state.leftSidebarVisible)`) as enforced by ast-grep rules.

7. **RTL-Compatible Styling**: Used CSS logical properties (`border-e`, `ps-`, `pe-`) for sidebar borders and padding to support future RTL layouts.

### Challenges & Solutions

1. **Test Setup with Router**: Testing components that use `useRouterState` required creating test-specific router instances with `createMemoryHistory`. Updated `test-utils.tsx` to provide a proper router wrapper that renders children while maintaining route state.

2. **Root Layout Integration**: The `__root.tsx` route wraps all content in `MainWindowShell`, while route content renders via `<Outlet />`. This required understanding TanStack Router's layout composition model.

3. **Route File Naming Convention**: TanStack Router's file-based routing uses a specific naming convention:
   - `route.tsx` = layout wrapper for nested routes
   - `index.tsx` = index route content
   - `$param.tsx` = dynamic parameter route
     This differs from the dot-based convention (`items.tsx`, `items.index.tsx`) mentioned in the task spec.

4. **Command System Integration**: Navigation commands use `router.navigate()` directly (not hooks) since execute functions aren't React components. This follows the existing pattern in the command system.

### Lessons Learned

1. **TanStack Router File Conventions**: The actual file-based routing structure uses folder-based organization (`/items/route.tsx`, `/items/index.tsx`) rather than flat dot-based naming (`items.tsx`, `items.index.tsx`). Both are valid but the folder approach is cleaner for nested routes.

2. **Router DevTools Placement**: DevTools should be inside the root layout component, not at the RouterProvider level, for proper context access.

3. **Type-Safe Route Parameters**: Using `Route.useParams()` from the route module provides full TypeScript inference for route parameters.

4. **Test Router Independence**: Navigation tests need their own router instances separate from the app router to control routing state during tests.

### Documentation Impact

1. **State Management Boundaries**: The task spec's state ownership table (URL/route params → TanStack Router, UI visibility → Zustand, Server data → TanStack Query) is now implemented and should be added to the architecture documentation.

2. **Testing Patterns**: The `test-utils.tsx` router wrapper pattern should be documented in `docs/developer/quality-tooling/testing.md`.

3. **Route File Conventions**: Consider adding a section to architecture docs explaining the folder-based route structure chosen over dot-based naming.

4. **Command System Pattern**: The pattern of using `router.navigate()` directly in command execute functions (vs. hooks) could be documented in `docs/developer/core-systems/command-system.md`.
